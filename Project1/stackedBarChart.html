<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Birth Rate for Women: Stacked Bar Charts</title>



</head>
<body>
<script src="https://d3js.org/d3.v4.js"></script>
<script>
    // Set the dimensions of the canvas / graph
    const margin = {top: 80, right: 20, bottom: 80, left: 50},
        width = 900- margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

    // Adds the svg canvas
    const svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform","translate(" + margin.left + "," + margin.bottom + ")");


    // set x scale
    const x = d3.scaleBand()
        .rangeRound([0,width])
        .paddingInner(0.02)
        .align(0.5);
    // set y scale
    const y = d3.scaleLinear()
        .rangeRound([height, 0]);
    // set color scale
    const z = d3.scaleOrdinal()
         .range(["#1b70fc", "#faff16", "#d50527", "#158940", "#f898fd", "#24c9d7", "#cb9b64", "#866888"]);


    // Define x and y axes
    const xAxis = d3.axisBottom(x)
        .ticks(5);
    const yAxis = d3.axisLeft(y)
        .ticks(10);

    //load the data
    d3.csv('birthRate.csv',function (error, data) {
        data.forEach(function (d) {
            d.year = +d.year;
            d.birthRate = +d.birthRate;
        });
        data.sort(function(a,b){
            if (a.year<b.year)
                return -1;
            else if (a.year>b.year)
                return 1;
            else
                return 0;
        })

        // group original data by years
        let newData = d3.nest().key(item=>item.year).entries(data);

        // for each year, create an object with key = age groups and values= birth rates
        newData = newData.map(item=>{
            const newItem = {year: +item.key};
            item.values.forEach(v=>{
               newItem[v.age] = v.birthRate;
            });
            return newItem;
        });
        const ages = d3.keys(newData[0]).splice(1);
        // ages.sort().reverse();
        // stack age groups per year
        const stack = d3.stack().keys(ages);
        const stackedData = stack(newData);




        // Define x and y axes
        const xAxis = d3.axisBottom(x)
            .ticks(5);
        const yAxis = d3.axisLeft(y)
            .ticks(5);

        x.domain(data.map(function (d) {return d.year;}));
        // y.domain([0, d3.max(dataset, function (d) {
        //     return d.total;
        // })]).nice();
        // x.domain(d3.extent(data, function(d) { return d.year; }));
        y.domain([0, d3.max(stackedData.flat().flat())]).nice();
        z.domain(ages);

        //add a group for each row of data
        // const groups = svg.selectAll("g")
        //     .data(stackedData)
        //     .enter()
        //     .append("g")
        //     .style("fill", function(d){return z(d.key);});

        //add a rect for each data value
        // let rects = groups.selectAll("rect")
        //     .data(function(d){return d;})
        //     .enter()
        //     .append("rect")
        //     .attr("x", function(d){return d.year;})
        //     .attr("y", function(d){return y(d[1]);})
        //     .attr("height", function(d){return y(d[0]) - y(d[1]);})
        //     .attr("width", x.bandwidth());

        svg.append("g")
            .selectAll("g")
            .data(stackedData)
            .enter().append("g")
            .attr("fill", function(d) { return z(d.key); })
            .selectAll("rect")
            .data(function(d) { return d; })
            .enter().append("rect")
            .attr("x", function(d) { return x(d.data.year); })
            .attr("y", function(d) { return y(d[1]); })
            .attr("height", function(d) { return y(d[0]) - y(d[1]); })
            .attr("width", x.bandwidth());

        debugger
        // draw the title of the chart
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "20px")
            // .style("text-decoration","underline")
            .text("Birth Rate for Females by Age Group: United States");

        // draw x axis with years tilted to save space
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
                .style("text-anchor","end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");
        // draw y axis
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(" + margin.left-.5  + ",0)")
            .call(yAxis);


    });




</script>
</body>
</html>